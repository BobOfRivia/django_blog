{% extends "base.html" %}

{% load django_markdown %}
{% block content %}
<form action="." method="post">{% csrf_token %}
    <p>
        <input type="text" name = 'title' id="txtTitle" placeholder={{post.title}} value={{post.title}} />
    </p>
    <p>
        <textarea id='editor' name='content' rows='30' style="width:99%" value="content" placehoder={{post.content}}>
            {{post.content}}
        </textarea>
    </p>
    <p>
        <input type="text" name = 'tag' id="txtTag" value={{post.category}} />
    </p>
    <input type="submit" value="保存">
</form>
{%for image in images%}
<p>
<li>
    <span id="justurl">
        {{image.image.url}}
    </span>
    <a href='#' id="1" onclick="insert_img(this); return false;">
        [插入]
    </a>
</li>
<script type="text/javascript">
    String.format = function() {
    if( arguments.length == 0 )
        return null;

    var str = arguments[0]; 
    for(var i=1;i<arguments.length;i++) {
        var re = new RegExp('\\{' + (i-1) + '\\}','gm');
        str = str.replace(re, arguments[i]);
    }
    return str;
    }
function insertAtCaret(areaId,text) {
    var txtarea = document.getElementById(areaId);
    var scrollPos = txtarea.scrollTop;
    var strPos = 0;
    var br = ((txtarea.selectionStart || txtarea.selectionStart == '0') ? 
        "ff" : (document.selection ? "ie" : false ) );
    if (br == "ie") { 
        txtarea.focus();
        var range = document.selection.createRange();
        range.moveStart ('character', -txtarea.value.length);
        strPos = range.text.length;
    }
    else if (br == "ff") strPos = txtarea.selectionStart;

    var front = (txtarea.value).substring(0,strPos);  
    var back = (txtarea.value).substring(strPos,txtarea.value.length); 
    txtarea.value=front+text+back;
    strPos = strPos + text.length;
    if (br == "ie") { 
        txtarea.focus();
        var range = document.selection.createRange();
        range.moveStart ('character', -txtarea.value.length);
        range.moveStart ('character', strPos);
        range.moveEnd ('character', 0);
        range.select();
    }
    else if (br == "ff") {
        txtarea.selectionStart = strPos;
        txtarea.selectionEnd = strPos;
        txtarea.focus();
    }
    txtarea.scrollTop = scrollPos;
}

    function insert_img(e){
        try {
            var o = e.previousSibling;
            while(o.nodeType != 1)
            {
                o=o.previousSibling;
            }
            var url = o.innerHTML;
            var str = String.format("<img src='{0}'>",url);
            insertAtCaret("editor", str);
        }
        catch (err) {
            alert(err.message);
        }
    }
</script>
</p>
{%endfor%}

<br>
<fieldset>
<legend>
</legend>
 <form action="{%url "upload_pic" %}" method="post" enctype="multipart/form-data">
 {% csrf_token %}
                <p>
                    <input id="id_image" type="file" class="" name="image">
                </p>
                <input type="submit" value="插入图片" />
</form>
</fieldset>
{% endblock %}